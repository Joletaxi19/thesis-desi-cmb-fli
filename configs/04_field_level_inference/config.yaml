# Field-Level Inference Configuration
# Based on benchmark-field-level paper (arXiv:2409.19049) MCLMC section

# SLURM configuration for NERSC Perlmutter
slurm:
  job_name: fli-mclmc-production
  account: desi
  qos: regular
  constraint: gpu
  nodes: 1
  gpus: 2  # Use 2 GPUs for 2 parallel chains (1 chain per GPU)
  time: "02:00:00"  # 2 hours (estimated: 40 min, margin for safety)

# Model configuration (following benchmark defaults)
model:
  mesh_shape: [48, 48, 48]  # REDUCED for guaranteed memory safety (was 64)
  box_shape: [200.0, 200.0, 200.0]  # Mpc/h REDUCED for memory (was 320)
  evolution: lpt
  lpt_order: 2  # 2LPT (more accurate than 1LPT, benchmark default)
  a_obs: 0.5  # Scale factor for observation (z~1, benchmark default)
  gxy_density: 0.001  # Galaxy number density [h³/Mpc³] (benchmark default)

# Truth parameters for synthetic data generation (benchmark defaults)
truth_params:
  Omega_m: 0.3
  sigma8: 0.8
  b1: 1.0
  b2: 0.0
  bs2: 0.0
  bn2: 0.0

# MCMC configuration (benchmark MCLMC settings)
mcmc:
  # Stage 1: Mesh warmup (fixed in code at 2^10=1024 steps)
  # Stage 2: All parameters warmup
  num_warmup: 4096  # Steps for all params (after mesh-only warmup)

  # Stage 3: Sampling
  num_samples: 4096  # Samples per chain REDUCED (was 8192)
  num_chains: 2  # CONSERVATIVE: 2 chains for guaranteed memory safety

  # MCLMC specific configuration
  mclmc:
    # Warmup hyperparameters (benchmark values)
    desired_energy_var: 0.000001  # 1e-6 for mesh warmup (stage 1)
    # Note: Stage 2 warmup uses 5e-4 (hard-coded in script)

    diagonal_preconditioning: false  # Benchmark uses false (full mass matrix)

    thinning: 8  # REDUCED thinning for more samples (was 16)
    # Effective samples: 4096/8 = 512 per chain → 2048 total samples

    # L recalculation parameters (benchmark approach)
    eval_per_ess: 1000  # Target: 1000 evals per effective sample
    # L = 0.4 * eval_per_ess/2 * step_size (computed after warmup)

# CMB Lensing configuration
cmb_lensing:
  enabled: false  # Set to true to compute convergence maps
  field_size_deg: 5.0  # Angular field size in degrees
  field_npix: 64  # Number of pixels for convergence map
  z_source: 1.0  # Source redshift for lensing

# Random seed
seed: 42
